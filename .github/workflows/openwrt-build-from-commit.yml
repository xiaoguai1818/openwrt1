name: Build OpenWrt SDK and Packages

on:
  workflow_dispatch:
    inputs:
      openwrt_repo:
        description: "OpenWrt repo URL"
        required: true
        default: "https://github.com/openwrt/openwrt.git"
      openwrt_commit:
        description: "OpenWrt commit or tag"
        required: true
        default: "38c150612c"
      target:
        description: "Target (e.g. mediatek/filogic)"
        required: true
        default: "mediatek/filogic"
      arch:
        description: "Architecture (e.g. aarch64_cortex-a53)"
        required: true
        default: "aarch64_cortex-a53"
      packages:
        description: "Packages to build (space separated)"
        required: true
        default: "ipset iptables-mod-tproxy iptables-mod-extra kmod-tun kmod-inet-diag kmod-nft-tproxy dnsmasq-full"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gcc g++ libncurses5-dev zlib1g-dev gawk gettext unzip file \
            libssl-dev python3-distutils rsync wget git

      - name: Clone OpenWrt source at specified commit
        run: |
          git clone "${{ github.event.inputs.openwrt_repo }}" openwrt
          cd openwrt
          git fetch --all
          git checkout "${{ github.event.inputs.openwrt_commit }}"
          git log -1 --oneline

      - name: Configure target for SDK build
        run: |
          cd openwrt
          TARGET="${{ github.event.inputs.target }}"
          TARGET_FAMILY="${TARGET%/*}"
          SUBTARGET="${TARGET#*/}"

          echo "CONFIG_TARGET_${TARGET_FAMILY}=y" > .config
          echo "CONFIG_TARGET_${TARGET_FAMILY}_${SUBTARGET}=y" >> .config

          make defconfig

      - name: Build tools, toolchain and SDK
        run: |
          cd openwrt

          make tools/install -j"$(nproc)" V=sc
          make toolchain/install -j"$(nproc)" V=sc
          make target/sdk -j"$(nproc)" V=sc

          TARGET="${{ github.event.inputs.target }}"
          TARGET_FAMILY="${TARGET%/*}"
          SUBTARGET="${TARGET#*/}"

          SDK_TARBALL=$(ls bin/targets/"$TARGET_FAMILY"/"$SUBTARGET"/openwrt-sdk-*.tar.xz | head -n1 || true)
          if [ -z "$SDK_TARBALL" ]; then
            echo "ERROR: SDK tarball not found under bin/targets/$TARGET_FAMILY/$SUBTARGET/"
            exit 1
          fi

          echo "SDK_TARBALL=$SDK_TARBALL" >> "$GITHUB_ENV"
          echo "Found SDK: $SDK_TARBALL"

      - name: Extract SDK
        run: |
          cd openwrt
          tar -Jxf "$SDK_TARBALL" -C ..
          cd ..
          SDK_DIR=$(ls -d openwrt-sdk-* | head -n1)
          echo "SDK_DIR=$SDK_DIR" >> "$GITHUB_ENV"
          echo "Using SDK dir: $SDK_DIR"

      - name: Prepare SDK feeds
        run: |
          cd "$SDK_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure packages in SDK
        run: |
          cd "$SDK_DIR"

          rm -f .config
          make defconfig

          PKGLIST="${{ github.event.inputs.packages }}"
          echo "Packages to build: $PKGLIST"

          KMOD_PKGS=""
          IPTABLES_EXTRA=0
          DNSMASQ_FULL=0
          BASE_PKGS=""

          for pkg in $PKGLIST; do
            case "$pkg" in
              kmod-*)
                KMOD_PKGS="$KMOD_PKGS $pkg"
                echo "CONFIG_PACKAGE_${pkg}=m" >> .config
                ;;
              iptables-mod-*)
                IPTABLES_EXTRA=1
                echo "CONFIG_PACKAGE_${pkg}=m" >> .config
                echo "CONFIG_PACKAGE_iptables=m" >> .config
                ;;
              dnsmasq-full)
                DNSMASQ_FULL=1
                echo "CONFIG_PACKAGE_dnsmasq=m" >> .config
                echo "CONFIG_PACKAGE_dnsmasq-full=m" >> .config
                ;;
              *)
                BASE_PKGS="$BASE_PKGS $pkg"
                echo "CONFIG_PACKAGE_${pkg}=m" >> .config
                ;;
            esac
          done

          make defconfig

          echo "KMOD_PKGS=$KMOD_PKGS" >> "$GITHUB_ENV"
          echo "BASE_PKGS=$BASE_PKGS" >> "$GITHUB_ENV"
          echo "IPTABLES_EXTRA=$IPTABLES_EXTRA" >> "$GITHUB_ENV"
          echo "DNSMASQ_FULL=$DNSMASQ_FULL" >> "$GITHUB_ENV"

      - name: Build selected packages in SDK
        run: |
          cd "$SDK_DIR"

          TARGET="${{ github.event.inputs.target }}"
          TARGET_FAMILY="${TARGET%/*}"
          SUBTARGET="${TARGET#*/}"

          if [ -n "$KMOD_PKGS" ]; then
            make package/kernel/linux/compile -j"$(nproc)" V=sc
          fi

          if [ "$IPTABLES_EXTRA" = "1" ]; then
            make package/iptables/compile -j"$(nproc)" V=sc
          fi

          if [ "$DNSMASQ_FULL" = "1" ]; then
            make package/dnsmasq/compile -j"$(nproc)" V=sc
          fi

          for pkg in $BASE_PKGS; do
            make "package/$pkg/compile" -j"$(nproc)" V=sc || true
          done

      - name: Collect .ipk artifacts
        run: |
          cd "$SDK_DIR"
          mkdir -p /tmp/ipk

          ARCH="${{ github.event.inputs.arch }}"
          TARGET="${{ github.event.inputs.target }}"
          TARGET_FAMILY="${TARGET%/*}"
          SUBTARGET="${TARGET#*/}"

          if [ -d "bin/packages/$ARCH" ]; then
            find "bin/packages/$ARCH" -maxdepth 3 -name '*.ipk' -exec cp -a {} /tmp/ipk/ \;
          fi

          if [ -d "bin/targets/$TARGET_FAMILY/$SUBTARGET" ]; then
            find "bin/targets/$TARGET_FAMILY/$SUBTARGET" -name '*.ipk' -exec cp -a {} /tmp/ipk/ \;
          fi

          ls -l /tmp/ipk || true

      - name: Upload .ipk as artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ipks
          path: /tmp/ipk/*.ipk


